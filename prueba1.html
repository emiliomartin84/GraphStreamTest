<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
		<style type="text/css">
			html {
				height: 100%
			}
			body {
				height: 100%;
				margin: 0;
				padding: 0
			}
			#map_canvas {
				height: 100%
			}
		</style>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQXIE3yBRjyhTHjvZYNsJJKn2mfWxub_M&sensor=true"></script>
		<script type="text/javascript">
			var hotels = [['36361.0.11:30.180/0', 40.428, -3.7341, 3, '572869', 'Cluster 0', ' h: Sat Dec 29 07:00:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 19:00:10 CET 2012', 1, 180.0], ['36341.0.13:20.120/0', 40.411, -3.7131, 3, '572869', 'Cluster 0', ' h: Sat Dec 29 10:51:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 20:00:10 CET 2012', 2, 120.0], ['87.0.12:50.60/0', 40.411, -3.7087, 3, '572869', 'Cluster 0', ' h: Sat Dec 29 12:58:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 21:00:10 CET 2012', 3, 60.0], ['36363.0.08:00.60/0', 40.505, -3.6657, 3, '572869', 'Cluster 0', ' h: Sat Dec 29 17:39:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 21:00:10 CET 2012', 4, 60.0], ['81.0.08:00.90/0', 40.409, -3.7073, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 07:00:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 20:30:10 CET 2012', 1, 90.0], ['90.0.08:00.60/0', 40.408, -3.7094, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 08:34:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 09:00:10 CET 2012', 2, 60.0], ['36325.0.12:25.120/0', 40.414, -3.7029, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 09:51:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 20:00:10 CET 2012', 3, 120.0], ['36217.0.16:25.90/0', 40.408, -3.6994, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 12:05:10 CET 2012', ' ini: Sat Dec 29 15:25:10 CET 2012', ' fin: Sat Dec 29 17:25:10 CET 2012', 4, 90.0], ['36331.0.10:30.60/0', 40.417, -3.7003, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 17:15:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 21:00:10 CET 2012', 5, 60.0], ['36402.0.19:40.60/0', 40.407, -3.6955, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 18:38:10 CET 2012', ' ini: Sat Dec 29 18:40:10 CET 2012', ' fin: Sat Dec 29 20:40:10 CET 2012', 6, 60.0], ['36302.0.12:00.60/0', 40.438, -3.7142, 3, 'B1DD74', 'Cluster 1', ' h: Sat Dec 29 20:55:10 CET 2012', ' ini: Sat Dec 29 07:00:10 CET 2012', ' fin: Sat Dec 29 21:00:10 CET 2012', 7, 60.0]];
			var map;
			var barr = [];
			function initialize() {

				var mapDiv = document.getElementById('map-canvas');

				var latlng = new google.maps.LatLng(40.428, -3.7341);

				var myOptions = {
					zoom : 11,
					center : latlng,
					mapTypeId : google.maps.MapTypeId.HYBRID
				};
				map = new google.maps.Map(mapDiv, myOptions);
				google.maps.event.addListenerOnce(map, 'tilesloaded', addMarkers);
			}

			function addMarkers() {
				var bounds = map.getBounds();
				var southWest = bounds.getSouthWest();
				var northEast = bounds.getNorthEast();
				var lngSpan = northEast.lng() - southWest.lng();
				var latSpan = northEast.lat() - southWest.lat();

				for (var i = 0; i < hotels.length; i++) {

					barr[i] = new Object;
					var hotel = hotels[i]
					var pinColor = hotel[4];
					var icon = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor, new google.maps.Size(21, 34), new google.maps.Point(0, 0), new google.maps.Point(10, 34));
					//icon.scaledSize = new google.maps.Size(15, 26);
					var marker = new google.maps.Marker({
						position : new google.maps.LatLng(hotel[1], hotel[2]),
						map : map,
						icon : icon,
						title : hotel[5] + '_' + hotel[9],
						zIndex : hotel[3]
					});

					barr[i].marker = marker;
					barr[i].html = '<div id="content">' + '<div id="siteNotice">' + '</div>' + '<div id="bodyContent">' + '<p> ' + hotel[5] + '<br />' + 'Servicio: ' + hotel[0] + '<br />' + 'Orden de visita: ' + hotel[9] + '<br />' + hotel[6] + '<br />' + hotel[7] + '<br />' + hotel[8] + '<br />' + 'Duraci&oacuten: ' + hotel[10] + '</p>' + '</div>' + '</div>';

					barr[i].infoWindow = new google.maps.InfoWindow({
						content : barr[i].html,
						maxWidth : 230
					});
					barr[i].cluster = hotel[5];
					barr[i].orden = hotel[9];
					barr[i].color = pinColor;

					barr[i].listener = makeClosure(i, barr[i].marker);
				}

			}

			// Make a simple closure with the listener...

			function makeClosure(i, marker) {
				var listener = google.maps.event.addListener(marker, 'click', function() {
					
					openInfoWindow(i);

					// <-- this is the key to making it work
				});
				return listener;
			}

			// Open the infoWindow - called from the closure...
			
			function openInfoWindow(i) {

				barr[i].infoWindow.open(map, barr[i].marker);
				if ( typeof (lastI) == 'number' && typeof (barr[lastI].infoWindow) == 'object') {
					barr[lastI].infoWindow.close();
				}
				lastI = i;
				showAndHideAllOther(i);

			}

			function showAndHideAllOther( i) {
				var cluster = barr[i].cluster;
				var flightPlanCoordinates = [  ];
				var color = "#"+barr[i].color;
				var aux ;
				for (var j = 0; j < barr.length; j++) {
					aux = aux+ barr[j].cluster + "==" +cluster +"\n";
					if (barr[j].cluster == cluster){
						//barr[j].marker.setVisible(true);
						flightPlanCoordinates.push(barr[j].marker.getPosition());
					}else
						barr[j].marker.setVisible(false);
					barr[j].marker.setVisible(false);
				}
				var flightPath = new google.maps.Polyline({
					path : flightPlanCoordinates,
					strokeColor : color,
					strokeOpacity : 0.8,
					strokeWeight : 2.5
				});
				
				 flightPath.setMap(map);
			}


			google.maps.event.addDomListener(window, 'load', initialize);
		</script>
	</head>
	<body onload="initialize()">
		<div id="map-canvas" style="width:100%; height:100%"></div>
	</body>
</html>